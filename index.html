<!DOCTYPE html> <!-- Declares the document type and version of HTML -->
<html lang="en"> <!-- Starts the HTML document and sets the language to English -->
<head>
    <meta charset="UTF-8"> <!-- Sets the character encoding for the document -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Ensures responsive design for mobile devices -->
    <title>Retirement Savings Calculator</title> <!-- Title of the webpage that appears in the browser tab -->
    <style>
        /* CSS styling for the webpage */
        body {
            font-family: Arial, sans-serif; /* Sets the font family */
            margin: 20px; /* Adds margin around the body */
        }

        .calculator, .result-page {
            max-width: 500px; /* Limits the maximum width of the calculator and result page */
            margin: 0 auto; /* Centers the content horizontally */
            display: none; /* Initially hides the calculator and result page */
        }

        .active {
            display: block; /* Displays the active section (calculator or result) */
        }

        label, input, .toggle-option {
            display: block; /* Makes labels and inputs block elements for stacking */
            margin: 10px 0; /* Adds vertical margin between elements */
        }

        input, select {
            padding: 10px; /* Adds padding inside input fields */
            width: 100%; /* Makes input fields full width */
        }

        button {
            padding: 10px 20px; /* Adds padding inside buttons */
            background-color: #40A7DD; /* Sets the button background color */
            color: white; /* Sets the button text color */
            border: none; /* Removes default border from buttons */
            border-radius: 5px; /* Rounds the corners of buttons */
            cursor: pointer; /* Changes cursor to pointer when hovering over button */
            font-size: 16px; /* Sets font size for button text */
        }

        button:hover {
            background-color: #007bff; /* Changes background color on hover */
        }

        .result {
            margin-top: 20px; /* Adds margin above the result section */
            font-size: 18px; /* Sets font size for result text */
        }

        canvas {
            margin-top: 20px; /* Adds margin above canvas elements for charts */
        }
        
        .table-container {
            display: flex; /* Enables flexbox layout for the table container */
            justify-content: center; /* Centers the table within the container */
            margin-top: 20px; /* Adds margin above the table container */
        }
        
        table {
            width: 100%; /* Sets the table width to 100% of its container */
            border-collapse: collapse; /* Removes space between table borders */
            margin-top: 20px; /* Adds margin above the table */
        }

        table, th, td {
            border: 1px solid #40A7DD; /* Adds border to table, header, and cells */
        }

        th, td {
            padding: 10px; /* Adds padding inside table header and cells */
            text-align: center; /* Centers text within table cells */
        }

        th {
            background-color: #40A7DD; /* Sets background color for table headers */
            color: white; /* Sets text color for table headers */
        }

        /* New CSS for button container */
        .button-container {
            display: flex;
            justify-content: space-between; /* Space buttons evenly */
            margin-bottom: 20px; /* Space below the buttons */
        }
        
    </style>
    <!-- Includes Chart.js library for creating charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Includes jsPDF library for generating PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Input Form -->
    <div class="calculator active" id="calculator"> <!-- Calculator section is initially active -->
        <h1>Retirement Savings Calculator</h1> <!-- Main heading for the calculator -->

        <label for="current-age">Current Age</label>
        <input type="number" id="current-age" min="0" max="100" placeholder="Enter your current age">

        <label for="retirement-age">Desired Retirement Age</label>
        <input type="number" id="retirement-age" min="0" max="100" placeholder="Enter your desired retirement age">

        <!-- Registered Retirement Savings -->
        <label for="registered-savings">Total Value of Registered Retirement Savings (RRSP, Spousal RRSP, RIF, LIF, LIRA, etc.)</label>
        <input type="number" id="registered-savings" min="0" placeholder="Enter total value of registered savings">

        <label for="registered-contribution">Contributions</label>
        <input type="number" id="registered-contribution" min="0" placeholder="Enter contribution amount">

        <label for="registered-contribution-type">Registered Savings Contribution Frequency</label> <!-- Label for contribution type -->
        <select id="registered-contribution-type"> <!-- Dropdown for selecting contribution frequency -->
            <option value="annual">Annual</option> <!-- Annual option -->
            <option value="monthly">Monthly</option> <!-- Monthly option -->
        </select>

        <!-- TFSA Savings -->
        <label for="tfsa-savings">Total Value of Tax-Free Savings Accounts (TFSAs)</label>
        <input type="number" id="tfsa-savings" min="0" placeholder="Enter total value of TFSAs">

        <label for="tfsa-contribution">Contributions</label>
        <input type="number" id="tfsa-contribution" min="0" placeholder="Enter contribution amount">

        <label for="tfsa-contribution-type">TFSA Contribution Frequency</label> <!-- Label for TFSA contribution type -->
        <select id="tfsa-contribution-type"> <!-- Dropdown for selecting contribution frequency -->
            <option value="annual">Annual</option> <!-- Annual option -->
            <option value="monthly">Monthly</option> <!-- Monthly option -->
        </select>

        <!-- Non-Registered Savings -->
        <label for="non-registered-savings">Total Value of Non-Registered Savings (Cash, Margin, Corporate, etc.)</label>
        <input type="number" id="non-registered-savings" min="0" placeholder="Enter total value of non-registered savings">

        <label for="non-registered-contribution">Contributions</label>
        <input type="number" id="non-registered-contribution" min="0" placeholder="Enter contribution amount">

        <label for="non-registered-contribution-type">Non-Registered Contribution Frequency</label> <!-- Label for non-registered contribution type -->
        <select id="non-registered-contribution-type"> <!-- Dropdown for selecting contribution frequency -->
             <option value="annual">Annual</option> <!-- Annual option -->
            <option value="monthly">Monthly</option> <!-- Monthly option -->
        </select>

        <!-- Rate of Return -->
        <label for="annual-rate">Expected Annual Rate of Return (%)</label>
        <input type="number" id="annual-rate" step="0.01" min="0" placeholder="Enter expected rate of return">

        <!-- Desired Cash Flow -->
        <label for="desiredCashFlow">Desired Pre-tax Income At Retirement (Annual):</label>
        <input type="number" id="desiredCashFlow" name="desiredCashFlow" step="1000" placeholder="Enter amount in dollars">
        
        <button onclick="calculateAndShowResult()">Calculate</button> <!-- Button to trigger calculation -->
    </div>

    <!-- Result Page -->
<div class="result-page" id="resultPage"> <!-- Div for displaying the result page -->
    <h1>Your Estimated Retirement Savings</h1> <!-- Heading for the result page -->

    <!-- Move buttons to the top -->
    <div class="button-container"> <!-- Container for the "Back" and "Print" buttons -->
        <button onclick="goBack()">Back</button> <!-- Button to go back to the calculator page -->
        <button onclick="saveAsPDF()">Print</button> <!-- Button to generate a PDF of the results -->
    </div>

    <div class="result" id="result"></div> <!-- Div to display the result of the calculations -->
    <canvas id="growthChart" width="500" height="250"></canvas> <!-- Canvas for the growth chart -->
    <canvas id="cashFlowChart" width="500" height="250"></canvas> <!-- Canvas for the cash flow chart -->
    
    <!-- Container for the Growth Table -->
    <div class="table-container"> 
        <table id="growthTable"> <!-- Table to display the growth data -->
            <thead>
                <tr>
                    <th>Year</th> <!-- Table header for year -->
                    <th>Age</th> <!-- Table header for age -->
                    <th>Registered Starting Value</th> <!-- Table header for registered savings starting value -->
                    <th>Registered Contribution</th> <!-- Table header for registered savings contribution -->
                    <th>Registered Savings</th> <!-- Table header for registered savings value -->
                    <th>TFSA Starting Value</th> <!-- Table header for TFSA starting value -->
                    <th>TFSA Contribution</th> <!-- Table header for TFSA contribution -->
                    <th>TFSA Value</th> <!-- Table header for TFSA value -->
                    <th>Non-Registered Starting Value</th> <!-- Table header for non-registered starting value -->
                    <th>Non-Registered Contribution</th> <!-- Table header for non-registered contribution -->
                    <th>Non-Registered Value</th> <!-- Table header for non-registered value -->
                    <th>Total Investment Value</th> <!-- Table header for total investment value -->
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated here dynamically for the growth table -->
            </tbody>
        </table>
    </div>

    <!-- Separate Container for the Cash Flow Table -->
    <div class="table-container"> 
        <table id="cashFlowTable" class="table table-striped"> <!-- Table to display the cash flow data -->
            <thead>
                <tr>
                    <th>Age</th>
                    <th>Actual Pre-tax Income ($)</th>
                    <th>Shortfall ($)</th>
                    <th>Surplus ($)</th>
                </tr>
            </thead>
            <tbody id="cashFlowTableBody">
                <!-- Rows will be added here dynamically for the cash flow table -->
            </tbody>
        </table>
    </div>
</div>

   <script>
        let growthChart, cashFlowChart; // Declare variables for chart instances to hold the charts

        function calculateAndShowResult() {
    // Retrieve user input values from the form
    const currentAge = parseInt(document.getElementById('current-age').value); // Get current age
    const retirementAge = parseInt(document.getElementById('retirement-age').value); // Get retirement age
    const registeredSavings = parseFloat(document.getElementById('registered-savings').value) || 0; // Get registered savings or default to 0
    const registeredContribution = parseFloat(document.getElementById('registered-contribution').value) || 0; // Get registered contributions or default to 0
    const tfsaSavings = parseFloat(document.getElementById('tfsa-savings').value) || 0; // Get TFSA savings or default to 0
    const tfsaContribution = parseFloat(document.getElementById('tfsa-contribution').value) || 0; // Get TFSA contributions or default to 0
    const nonRegisteredSavings = parseFloat(document.getElementById('non-registered-savings').value) || 0; // Get non-registered savings or default to 0
    const nonRegisteredContribution = parseFloat(document.getElementById('non-registered-contribution').value) || 0; // Get non-registered contributions or default to 0
    const annualRate = parseFloat(document.getElementById('annual-rate').value) / 100; // Get the annual interest rate and convert it to a percentage
    const registeredContributionType = document.getElementById('registered-contribution-type').value; // Get contribution type for registered savings
    const tfsaContributionType = document.getElementById('tfsa-contribution-type').value; // Get contribution type for TFSA
    const nonRegisteredContributionType = document.getElementById('non-registered-contribution-type').value; // Get contribution type for non-registered savings

    // Validate input values
    if (isNaN(currentAge) || isNaN(retirementAge) || isNaN(annualRate) || currentAge >= retirementAge) {
        alert('Please enter valid values.'); // Show an alert if the inputs are invalid
        return; // Exit the function if invalid
    }

    // Adjust contributions based on selected frequency (monthly or annually)
    const adjustedRegisteredContribution = (registeredContributionType === 'monthly') ? registeredContribution * 12 : registeredContribution;
    const adjustedTFSAContribution = (tfsaContributionType === 'monthly') ? tfsaContribution * 12 : tfsaContribution;
    const adjustedNonRegisteredContribution = (nonRegisteredContributionType === 'monthly') ? nonRegisteredContribution * 12 : nonRegisteredContribution;

    const yearsToRetirement = retirementAge - currentAge; // Calculate the number of years until retirement

    // Initialize data storage for chart and table
    const chartData = {
        registered: [], // Array for registered savings data
        tfsa: [], // Array for TFSA data
        nonRegistered: [] // Array for non-registered savings data
    };
    const tableData = []; // Array for table data
    let futureValueRegistered = registeredSavings; // Future value of registered savings
    let futureValueTFSA = tfsaSavings; // Future value of TFSA
    let futureValueNonRegistered = nonRegisteredSavings; // Future value of non-registered savings

    // Loop through each year from current age to retirement age
    for (let i = 0; i <= yearsToRetirement; i++) {
        const registeredContribution = adjustedRegisteredContribution; // Get registered contribution for the year
        const tfsaContribution = adjustedTFSAContribution; // Get TFSA contribution for the year
        const nonRegisteredContribution = adjustedNonRegisteredContribution; // Get non-registered contribution for the year

        // Store savings values before contributions are added
        const registeredValueBeforeContribution = futureValueRegistered;
        const tfsaValueBeforeContribution = futureValueTFSA;
        const nonRegisteredValueBeforeContribution = futureValueNonRegistered;

        // Add contributions to the savings
        futureValueRegistered += registeredContribution;
        futureValueTFSA += tfsaContribution;
        futureValueNonRegistered += nonRegisteredContribution;

        // Add growth to the savings based on the annual rate
        futureValueRegistered += futureValueRegistered * annualRate;
        futureValueTFSA += futureValueTFSA * annualRate;
        futureValueNonRegistered += futureValueNonRegistered * annualRate;

        // Store the updated savings values in chartData
        chartData.registered.push(futureValueRegistered);
        chartData.tfsa.push(futureValueTFSA);
        chartData.nonRegistered.push(futureValueNonRegistered);

        // Prepare the data for the results table
        tableData.push({
            age: currentAge + i, // Age for the current row
            totalValue: futureValueRegistered + futureValueTFSA + futureValueNonRegistered, // Total savings value for the current row
            registeredValueBeforeContribution: registeredValueBeforeContribution, // Registered savings before contributions
            registeredValue: futureValueRegistered, // Registered savings after growth
            registeredContribution: registeredContribution, // Registered contribution amount
            tfsaValueBeforeContribution: tfsaValueBeforeContribution, // TFSA before contributions
            tfsaValue: futureValueTFSA, // TFSA after growth
            tfsaContribution: tfsaContribution, // TFSA contribution amount
            nonRegisteredValueBeforeContribution: nonRegisteredValueBeforeContribution, // Non-registered savings before contributions
            nonRegisteredValue: futureValueNonRegistered, // Non-registered savings after growth
            nonRegisteredContribution: nonRegisteredContribution // Non-registered contribution amount
        });
    }

    const totalFutureValue = futureValueRegistered + futureValueTFSA + futureValueNonRegistered; // Calculate the total savings at retirement
    document.getElementById('result').innerHTML = `Your estimated savings at retirement: $${totalFutureValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`; // Display the total savings result

    document.getElementById('growthChart').width = 1000; 
    document.getElementById('growthChart').height = 500;
    createGrowthChart(chartData, currentAge, retirementAge); // Call function to generate growth chart
    createGrowthTable(tableData); // Call function to populate the growth table
    createCashFlowChart(totalFutureValue, retirementAge, annualRate); // Call function to generate cash flow chart

    // Switch from calculator to result page
    document.getElementById('calculator').classList.remove('active'); // Hide the calculator page
    document.getElementById('resultPage').classList.add('active'); // Show the result page

    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to the top of the page
}

        function createGrowthChart(chartData, currentAge, retirementAge) {
            const labels = []; // Array to hold age labels for the chart
            const currentYear = new Date().getFullYear(); // Get the current year

            // Create labels for each age from current to retirement
            for (let i = currentAge; i <= retirementAge; i++) {
                const year = currentYear + (i - currentAge); // Calculate year for the label
                labels.push(`${i} (${year})`); // Add label in format "age (year)"
            }

            const ctx = document.getElementById('growthChart').getContext('2d'); // Get 2D context for chart
            if (growthChart) {
                growthChart.destroy(); // Destroy previous chart instance if it exists
            }
            
            // Create a new bar chart
            growthChart = new Chart(ctx, {
                type: 'bar', // Chart type
                data: {
                    labels: labels, // Use age labels for the x-axis
                    datasets: [
                        {
                            label: 'Registered Retirement Savings', // Dataset label
                            data: chartData.registered, // Data for registered savings
                            backgroundColor: '#126090', // Bar color for registered savings
                            stack: 'combined', // Stack this dataset
                        },
                        {
                            label: 'TFSAs', // Dataset label
                            data: chartData.tfsa, // Data for TFSA
                            backgroundColor: '#40A7DD', // Bar color for TFSA
                            stack: 'combined', // Stack this dataset
                        },
                        {
                            label: 'Non-Registered Savings', // Dataset label
                            data: chartData.nonRegistered, // Data for non-registered savings
                            backgroundColor: '#83D3F6', // Bar color for non-registered savings
                            stack: 'combined', // Stack this dataset
                        }
                    ]
                },
                options: {
                    scales: {
                        x: { stacked: true }, // Stack the x-axis data
                        y: { stacked: true } // Stack the y-axis data
                    }

                }
            });
        }

        function createGrowthTable(tableData) {
    const tableBody = document.getElementById('growthTable').getElementsByTagName('tbody')[0]; // Get table body element
    tableBody.innerHTML = ''; // Clear any previous data in the table

    const currentYear = new Date().getFullYear(); // Get the current year

    tableData.forEach((row, index) => {
        const year = currentYear + index; // Increment the year for each row

        // Create a new table row
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td>${year}</td> <!-- Year column -->
            <td>${row.age}</td> <!-- Age column -->

            <!-- Registered savings columns -->
            <td>$${row.registeredValueBeforeContribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- Registered value before contribution -->
            <td>$${row.registeredContribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- Registered contribution column -->
            <td>$${row.registeredValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- Registered savings after growth column -->

            <!-- TFSA columns -->
            <td>$${row.tfsaValueBeforeContribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- TFSA value before contribution -->
            <td>$${row.tfsaContribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- TFSA contribution column -->
            <td>$${row.tfsaValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- TFSA value after growth column -->

            <!-- Non-registered savings columns -->
            <td>$${row.nonRegisteredValueBeforeContribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- Non-registered value before contribution -->
            <td>$${row.nonRegisteredContribution.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- Non-registered contribution column -->
            <td>$${row.nonRegisteredValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td> <!-- Non-registered savings value after growth column -->

            <!-- Total Investment Value column -->
            <td style="font-weight: bold;">$${row.totalValue.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</td>
        `;

        tableBody.appendChild(tr); // Append the row to the table body
    });
}

    function createCashFlowChart(totalValue, retirementAge, annualRate, costOfLivingIncrease = 0.031) {
    const currentAge = parseInt(document.getElementById('current-age').value); // Get current age from input
    const desiredCashFlow = parseFloat(document.getElementById('desiredCashFlow').value); // Get desired cash flow after retirement

    const actualCashFlowData = []; // Array to hold the actual cash flow (the amount withdrawn)
    const shortfallData = []; // Array to hold shortfall data
    const surplusData = []; // Array to hold surplus data
    const yearsAfterRetirement = 100 - retirementAge; // Years from retirement age to lifespan of 100

    console.log('Current Age:', currentAge);
    console.log('Retirement Age:', retirementAge);
    console.log('Years After Retirement:', yearsAfterRetirement);
    console.log('Total Value:', totalValue);
    console.log('Annual Growth Rate (from calculateAndShowResult):', annualRate);
    console.log('Cost of Living Increase:', costOfLivingIncrease);
    console.log('Desired Annual Cash Flow:', desiredCashFlow);

    let totalDiscountFactor = 0;
    for (let t = 1; t <= yearsAfterRetirement; t++) {
        totalDiscountFactor += 1 / Math.pow(1 + annualRate, t);
    }

    console.log('Total Discount Factor:', totalDiscountFactor);

    let annualWithdrawal = 0;
    if (yearsAfterRetirement > 0 && totalValue > 0) {
        annualWithdrawal = totalValue / totalDiscountFactor; 
    }

    console.log('Initial Annual Withdrawal:', annualWithdrawal);

    let remainingBalance = totalValue;
    let currentYear = currentAge;

    // Loop through each year but only generate data starting from retirement age up to age 100
    for (let i = retirementAge; i <= 100; i++) {
        if (i < retirementAge) {
            actualCashFlowData.push(0); // No withdrawals before retirement
            shortfallData.push(0); // No shortfall before retirement
            surplusData.push(0); // No surplus before retirement
        } else {
            // Apply cost of living increase to both withdrawals and desired cash flow
            const adjustedWithdrawal = annualWithdrawal * Math.pow(1 + costOfLivingIncrease, i - retirementAge);
            const adjustedDesiredCashFlow = desiredCashFlow * Math.pow(1 + costOfLivingIncrease, i - retirementAge);

            if (adjustedWithdrawal < adjustedDesiredCashFlow) {
                // Shortfall case: Only part of the desired cash flow can be withdrawn
                actualCashFlowData.push(adjustedWithdrawal); // Blue bar reflects the actual amount withdrawn
                shortfallData.push(adjustedDesiredCashFlow - adjustedWithdrawal); // Red bar for the shortfall amount
                surplusData.push(0); // No surplus
            } else {
                // Surplus case: Full desired cash flow met, surplus shown separately
                actualCashFlowData.push(adjustedDesiredCashFlow); // Blue bar reflects the desired amount
                shortfallData.push(0); // No shortfall
                surplusData.push(adjustedWithdrawal - adjustedDesiredCashFlow); // Green bar for surplus amount
            }

            console.log(`Year ${i}, Withdrawal: ${adjustedWithdrawal.toFixed(2)}, Desired Cash Flow: ${adjustedDesiredCashFlow.toFixed(2)}, Surplus/Shortfall calculated.`);

            // Update remaining balance considering withdrawal and growth
            remainingBalance -= adjustedWithdrawal;
            remainingBalance *= (1 + annualRate); // Apply growth rate to remaining balance
        }
        currentYear++;
    }

    console.log('Actual Cash Flow Data:', actualCashFlowData);
    console.log('Shortfall Data:', shortfallData);
    console.log('Surplus Data:', surplusData);

    const ctx = document.getElementById('cashFlowChart').getContext('2d');
    if (cashFlowChart) cashFlowChart.destroy();

    // Update chart labels to start at retirement age and go up to age 100
    const chartLabels = Array.from({ length: yearsAfterRetirement + 1 }, (_, i) => `Age ${i + retirementAge}`);

    cashFlowChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels, // Labels from retirement age to age 100
            datasets: [{
                label: 'Actual Pre-tax Income',
                data: actualCashFlowData,
                backgroundColor: '#40A7DD', // Blue bars for actual cash flow (withdrawals)
            },
            {
                label: 'Shortfall',
                data: shortfallData,
                backgroundColor: 'red', // Red bars for shortfall
            },
            {
                label: 'Surplus',
                data: surplusData,
                backgroundColor: 'green', // Green bars for surplus
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true // Enable stacking on the x-axis
                },
                y: {
                    beginAtZero: true,
                    stacked: true, // Enable stacking on the y-axis
                    title: {
                        display: true,
                        text: 'Annual Pre-tax Income ($)',
                    },
                }
            }
        }
    });

    // Call function to generate cash flow table
    generateCashFlowTable(actualCashFlowData, shortfallData, surplusData, retirementAge);
}

       // Function to generate cash flow table
function generateCashFlowTable(actualCashFlowData, shortfallData, surplusData, retirementAge) {
    const tableBody = document.getElementById('cashFlowTableBody'); // Assuming there's a table body with this ID
    tableBody.innerHTML = ''; // Clear any previous data

    for (let i = 0; i < actualCashFlowData.length; i++) {
        const age = retirementAge + i;
        const actualCashFlow = actualCashFlowData[i].toFixed(2); // Round to two decimal places
        const shortfall = shortfallData[i].toFixed(2);
        const surplus = surplusData[i].toFixed(2);

        // Create a new row
        const row = document.createElement('tr');

        // Create and append the Age cell
        const ageCell = document.createElement('td');
        ageCell.textContent = age;
        row.appendChild(ageCell);

        // Create and append the Actual Pre-tax Income cell
        const actualCashFlowCell = document.createElement('td');
        actualCashFlowCell.textContent = `$${actualCashFlow}`; // Add dollar sign and format value
        row.appendChild(actualCashFlowCell);

        // Create and append the Shortfall cell
        const shortfallCell = document.createElement('td');
        shortfallCell.textContent = `$${shortfall}`; // Add dollar sign and format value
        row.appendChild(shortfallCell);

        // Create and append the Surplus cell
        const surplusCell = document.createElement('td');
        surplusCell.textContent = `$${surplus}`; // Add dollar sign and format value
        row.appendChild(surplusCell);

        // Append the row to the table body
        tableBody.appendChild(row);
    }
}
       
        function goBack() {
            document.getElementById('resultPage').classList.remove('active'); // Hide result page
            document.getElementById('calculator').classList.add('active'); // Show calculator
        }

        function saveAsPDF() {
    const { jsPDF } = window.jspdf; // Import jsPDF library
    const doc = new jsPDF('l', 'pt', 'a4'); // Create a new PDF document with landscape orientation

    // Retrieve input values again to ensure they are available
    const currentAge = parseInt(document.getElementById('current-age').value);
    const retirementAge = parseInt(document.getElementById('retirement-age').value);
    const registeredSavings = parseFloat(document.getElementById('registered-savings').value) || 0;
    const registeredContribution = parseFloat(document.getElementById('registered-contribution').value) || 0;
    const tfsaSavings = parseFloat(document.getElementById('tfsa-savings').value) || 0;
    const tfsaContribution = parseFloat(document.getElementById('tfsa-contribution').value) || 0;
    const nonRegisteredSavings = parseFloat(document.getElementById('non-registered-savings').value) || 0;
    const nonRegisteredContribution = parseFloat(document.getElementById('non-registered-contribution').value) || 0;
    const annualRate = parseFloat(document.getElementById('annual-rate').value) / 100;
    const registeredContributionType = document.getElementById('registered-contribution-type').value;
    const tfsaContributionType = document.getElementById('tfsa-contribution-type').value;
    const nonRegisteredContributionType = document.getElementById('non-registered-contribution-type').value;

    // Add title to PDF
    doc.setFontSize(18);
    const title = 'Retirement Savings Summary';
    const titleWidth = doc.getTextWidth(title); // Get the width of the title text
    const pageWidth = doc.internal.pageSize.width; // Get the PDF page width
    const xPosition = (pageWidth - titleWidth) / 2; // Calculate X position for centering
    doc.text(title, xPosition, 30); // Use the calculated xPosition for centering

    // Add assumptions section
    doc.setFontSize(12);
    doc.text('Assumptions:', 20, 60);
    doc.setFontSize(10);
    const assumptions = [
    `Current Age: ${currentAge}`,
    `Desired Retirement Age: ${retirementAge}`,
    `Value of Registered Savings: $${registeredSavings.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
    `Registered Contributions: $${registeredContribution.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${registeredContributionType})`,
    `Value of TFSA: $${tfsaSavings.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
    `TFSA Contributions: $${tfsaContribution.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${tfsaContributionType})`,
    `Value of Non-registered: $${nonRegisteredSavings.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
    `Non-registered Contributions: $${nonRegisteredContribution.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${nonRegisteredContributionType})`,
    `Expected Rate of Return: ${(annualRate * 100).toFixed(2)}%`
    ];
    assumptions.forEach((text, index) => {
        doc.text(text, 20, 80 + index * 20);
    });

    // Add space between assumptions and charts
    let yPosition = 80 + assumptions.length * 20 + 20;

    // Add growth chart
    const growthChartCanvas = document.getElementById('growthChart');
    const growthChartImage = growthChartCanvas.toDataURL('image/png');
    const chartWidth = 240, chartHeight = 200;
    doc.addImage(growthChartImage, 'PNG', 20, yPosition, chartWidth, chartHeight);

    // Add cash flow chart
    const cashFlowChartCanvas = document.getElementById('cashFlowChart');
    const cashFlowChartImage = cashFlowChartCanvas.toDataURL('image/png');
    doc.addImage(cashFlowChartImage, 'PNG', 300, yPosition, chartWidth, chartHeight);

    // Update yPosition for the next section
    yPosition += chartHeight + 20;

    // Add growth table to PDF using autoTable
    doc.setFontSize(14);
    doc.text('Growth Table:', 20, yPosition);
    yPosition += 20; // Adjust y position for table

    // Prepare the table headers and rows from the growth table
    const tableBody = document.getElementById('growthTable').getElementsByTagName('tbody')[0];
    const rows = tableBody.getElementsByTagName('tr');

    // Extract headers
    const tableHeader = Array.from(document.getElementById('growthTable').getElementsByTagName('thead')[0].getElementsByTagName('th')).map(th => th.innerText);
    
    // Extract rows data
    const tableData = Array.from(rows).map(row => Array.from(row.getElementsByTagName('td')).map(td => td.innerText));

    // Use autoTable plugin to add the table
    doc.autoTable({
        head: [tableHeader],
        body: tableData,
        startY: yPosition,
        theme: 'grid',
        styles: {
            fontSize: 8,
            cellPadding: 4,
            overflow: 'linebreak',
        },
        headStyles: {
            fillColor: '#40A7DD',
        },
        columnStyles: {
            [tableHeader.length - 1]: { fontStyle: 'bold' },
        },
    });

    // Add cash flow description
    yPosition += 20;
    doc.setFontSize(12);
    doc.text("Understanding Your Cash Flow Numbers:", 20, yPosition);
    yPosition += 15; // Move down for the body text
    doc.setFontSize(10);

    const cashFlowDescription = [
        "The cash flow numbers you see in this calculator are based on your total retirement savings and your desired annual cash flow. Here's how they were calculated:",
        "",
        "1. Initial Annual Withdrawal Calculation: The calculator estimates the amount you can withdraw annually based on your total retirement savings and your expected lifespan of up to 100 years. It does this by considering a discount factor that reflects the impact of your investments growing over time.",
        "",
        "2. Adjusting for Cost of Living: Each year, your desired cash flow and the actual withdrawals are adjusted for a cost of living increase (default is 3.1%). This means that as inflation rises, both your desired withdrawals and the actual amounts you can take out will increase over time to help maintain your purchasing power.",
        "",
        "3. Shortfall and Surplus Analysis: If the adjusted amount you can withdraw is less than your desired cash flow, the difference is shown as a shortfall. Conversely, if you can withdraw more than your desired amount, the excess is represented as a surplus.",
        "",
        "Important Note: This calculator does not take into account any taxes that may apply to your withdrawals, so the amounts presented reflect pre-tax income. It’s essential to consider how taxes might affect your actual cash flow when planning your retirement."
    ];

    cashFlowDescription.forEach((line, index) => {
        doc.text(line, 20, yPosition + (index * 10));
    });

    yPosition += (cashFlowDescription.length * 10) + 10; // Update yPosition for the next section

    // Add disclaimer
    doc.setFontSize(7);
    doc.text('Disclaimer: The information and values presented in this document are for illustration purposes only and should not be considered financial advice. Actual investment results may vary. Please consult with a financial professional for specific advice tailored to your situation.', 20, doc.internal.pageSize.height - 30, {
        maxWidth: 550,
    });

    // Save the PDF
    doc.save('retirement_savings_summary.pdf');
}


    </script>
</body>
</html>
